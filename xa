local OrionLib = {
    Windows = {},
    Elements = {},
    Flags = {}
}

-- Обход блокировки инжектора
local function SafeGetService(name)
    local success, service = pcall(game.GetService, game, name)
    return success and service
end

local TweenService = SafeGetService("TweenService") or {Create = function() end}
local UserInputService = SafeGetService("UserInputService") or {InputBegan = Instance.new("BindableEvent")}
local CoreGui = SafeGetService("CoreGui") or game:FindFirstChild("CoreGui") or Instance.new("Folder")

function OrionLib:MakeWindow(config)
    config = config or {}
    local window = {
        Tabs = {},
        Name = config.Name or "HelixKey System",
        Size = config.Size or UDim2.new(0, 500, 0, 400),
        Position = config.Position or UDim2.new(0.5, -250, 0.5, -200)
    }
    
    -- Создание GUI
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "XenoSafeOrion_"..tostring(math.random(10000,99999))
    screenGui.Parent = CoreGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = window.Size
    mainFrame.Position = window.Position
    mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, 8)
    uiCorner.Parent = mainFrame
    
    -- Заголовок
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleText = Instance.new("TextLabel")
    titleText.Text = window.Name
    titleText.TextColor3 = Color3.new(1, 1, 1)
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 14
    titleText.BackgroundTransparency = 1
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.Size = UDim2.new(0, 300, 1, 0)
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    -- Кнопка закрытия
    local closeButton = Instance.new("TextButton")
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.Size = UDim2.new(0, 30, 0, 30)
    closeButton.Position = UDim2.new(1, -30, 0, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.BorderSizePixel = 0
    closeButton.Parent = titleBar
    
    -- Контейнер вкладок
    local tabContainer = Instance.new("Frame")
    tabContainer.Size = UDim2.new(1, 0, 1, -30)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundTransparency = 1
    tabContainer.Parent = mainFrame
    
    -- Функция создания вкладки
    function window:MakeTab(tabConfig)
        local tab = {
            Name = tabConfig.Name or "Tab",
            Elements = {}
        }
        
        local tabFrame = Instance.new("ScrollingFrame")
        tabFrame.Size = UDim2.new(1, 0, 1, 0)
        tabFrame.BackgroundTransparency = 1
        tabFrame.ScrollBarThickness = 5
        tabFrame.Visible = false
        tabFrame.Parent = tabContainer
        
        local layout = Instance.new("UIListLayout")
        layout.Padding = UDim.new(0, 5)
        layout.Parent = tabFrame
        
        -- Активация вкладки
        function tab:Show()
            for _, t in ipairs(window.Tabs) do
                t.Frame.Visible = false
            end
            tabFrame.Visible = true
        end
        
        -- Создание кнопки
        function tab:AddButton(btnConfig)
            local button = Instance.new("TextButton")
            button.Text = btnConfig.Name or "Button"
            button.Size = UDim2.new(1, -20, 0, 35)
            button.Position = UDim2.new(0, 10, 0, 0)
            button.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
            button.TextColor3 = Color3.new(1, 1, 1)
            button.Font = Enum.Font.Gotham
            button.TextSize = 12
            button.Parent = tabFrame
            
            button.MouseButton1Click:Connect(function()
                pcall(btnConfig.Callback)
            end)
        end
        
        -- Создание переключателя
        function tab:AddToggle(toggleConfig)
            local toggleFrame = Instance.new("Frame")
            toggleFrame.Size = UDim2.new(1, -20, 0, 30)
            toggleFrame.BackgroundTransparency = 1
            toggleFrame.Parent = tabFrame
            
            local label = Instance.new("TextLabel")
            label.Text = toggleConfig.Name or "Toggle"
            label.TextColor3 = Color3.new(1, 1, 1)
            label.Font = Enum.Font.Gotham
            label.TextSize = 12
            label.BackgroundTransparency = 1
            label.Size = UDim2.new(0.7, 0, 1, 0)
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = toggleFrame
            
            local toggle = Instance.new("TextButton")
            toggle.Size = UDim2.new(0, 50, 0, 25)
            toggle.Position = UDim2.new(0.8, 0, 0.1, 0)
            toggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
            toggle.Text = ""
            toggle.Parent = toggleFrame
            
            local state = toggleConfig.Default or false
            
            local function update()
                if state then
                    toggle.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
                else
                    toggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
                end
                
                if toggleConfig.Callback then
                    pcall(toggleConfig.Callback, state)
                end
            end
            
            toggle.MouseButton1Click:Connect(function()
                state = not state
                update()
            end)
            
            update()
        end
        
        -- Активируем первую вкладку
        if #window.Tabs == 0 then
            tab:Show()
        end
        
        table.insert(window.Tabs, tab)
        return tab
    end
    
    -- Закрытие окна
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)
    
    -- Перетаскивание окна
    local dragging = false
    local dragStart, startPos
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)
    
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return window
end

return OrionLib
